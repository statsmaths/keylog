---
title: "keylog: Example Usage"
output:
  html_document:
    theme: cosmo
    highlight: zenburn
    css: "note-style.css"
---

This is a short document illustrating how to use the **keylog** package, which
is designed to work with output generated by the JavaScript keylogging
application which can be found here:

  - https://statsmaths.github.io/keylog/

It generates a data set of key strokes that is stored locally in the DOM and
can be downloaded as a CSV file. To start, let's load the R package. 

```{r message=FALSE}
library(keylog)
```

We will work with a small example file that is contained within the package.

# Read a keylog file

To start, let's just read in the example data set using the function
`klog_readfile`. Reading the CSV file using `read.csv` or `read_csv` would
mostly work okay, but this function handles some special logic concerning the
special keys *Enter* and *Space*. It also makes sure that the column types are
determined consistently.

```{r}
example_path <- system.file("keylogs-1622057428556.csv", package = "keylog")
dt <- klog_readfile(example_path)
dt
```

The data contains information about all events that occurring during the
keylog session. The fields available are:

- **time**: time stamp in milliseconds since the Unix epoch
- **type**: the event type; either 'down' for a key being pressed, 'up' for a
key being released, 'click' for a mouse click, or 'paste' for pasted text from
the clipboard
- **key**: for key press and release events, the actual value of the key press;
for a paste event, this is the pasted text; for a click event, this value is
missing
- **key_code** for key press and release events, this is the name of the
physical key on the keyboard rather than the specific layout choosen by the
user; the names are associated, roughly, with a US-based QWERTY layout; value
is missing for click and paste events
- **alt_key**: was the alt key pressed at the time? not available for the paste
event
- **ctrl_key**: was the ctrl key pressed at the time? not available for the
paste event
- **meta_key**: was the meta key pressed at the time? not available for the
paste event
- **shift_key**: was the alt key pressed at the time? not available for the
paste event
- **is_repeat**: is this a key that is automatically repeating because the key
is held down? always false for paste and mouse events; it is usually false for
key down events, but may be triggered on some devices
- **range_start**: at the time of the event, the location as an integer offset
in the box of either the cursor or the start of any selected text
- **range_end**: at the time of the event, the location as an integer offset
in the box of either the cursor or the end of any selected text

The R package contains some useful functions for working with this data.

# Augement keylog data to the level of individual keys

Often, we want to associate the key down event of a key with a key up event.
This can be handled by the function `klog_events`. It returns a smaller data
set with one row for each key press, paste, or click event.

```{r}
events <- klog_events(dt)
events
```

This data set is perfect for addressing psycho-linguistic questions about how 
specific letters and words are being typed. Additional visualizations of this
data are included below.

# Text Creation

We can also recreate the text as it is being typed. This is useful for a larger
scale study of how texts are created.

```{r}
cur_text <- klog_create_text(dt)
cur_text
```

Here is the full text as it is being created:

```{r}
cur_text$current_text
```

Note that this currently does not handle deleting or pasting over a highlighted
section correctly.

# A bit of Visualization

Finally, let's see how we can visualize the key press data. We load some 
functions for data visualization:

```{r, message=FALSE}
library(tidyverse)
theme_set(theme_minimal())
```

Then, we can see when each key is pressed as a function of time:

```{r}
events %>%
  mutate(key = fct_inorder(key)) %>%
  mutate(rn = row_number()) %>%
  ggplot(aes(time / 1000, rn, color = modkey)) +
    geom_segment(aes(xend = time_up / 1000, yend = rn)) +
    geom_point() +
    geom_point(aes(x = time_up / 1000, y = rn)) +
    scale_color_viridis_d() +
    scale_y_continuous(labels = NULL) +
    labs(color = "Modifier Key?", x = "Time (seconds)", y = "") +
    theme_minimal()
```

Alternatively, we can see the actual keys being pressed:

```{r}
events %>%
  mutate(key = fct_inorder(key)) %>%
  mutate(rn = row_number()) %>%
  ggplot(aes(time / 1000, rn)) +
    geom_text(aes(label = key), size = 2) +
    labs(x = "Time (seconds)", y = "") +
    scale_y_continuous(labels = NULL) +
    theme_minimal()
```



